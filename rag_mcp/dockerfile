FROM python:3.12-slim

ENV UV_LINK_MODE=copy
ENV UV_PROJECT_ENVIRONMENT=/opt/venv

WORKDIR /app

RUN pip install --no-cache-dir uv

COPY pyproject.toml uv.lock* ./

RUN uv sync --no-dev

COPY . .

CMD ["sh", "-lc", "\
  if [ \"$DEBUG\" = \"1\" ]; then \
    exec uv run python -Xfrozen_modules=off -m debugpy \
      --listen 0.0.0.0:5678 \
      server.py; \
  else \
    exec uv run python server.py; \
  fi \
"]